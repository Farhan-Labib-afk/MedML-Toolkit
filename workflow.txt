# -*- coding: utf-8 -*-
from AIpmt import AIpmt
# Import libraries
import joblib
import pandas as pd

# Read the data file
df = pd.read_csv("data.csv")  # Use pandas to read the CSV file
print(df)
X = df.iloc[:, :-1]  # Extract the first 41 columns as features
y = df.iloc[:, -1]  # Extract the last column as labels

from sklearn.model_selection import train_test_split

# Split the dataset
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42, stratify=y)
# Create an AIpmt instance, providing the training data
classfier = AIpmt(X_train, y_train)
# Plot data distribution
classfier.plot_density(X_train, y_train, out=False)
# Plot data clustering
classfier.plot_cluster(X_train, y_train, cluster="TSNE", out=False)
# Plot feature correlation
classfier.plot_correlation(X_train, y_train, out=False)
# Feature engineering (using incremental feature selection based on an LR model)
classfier.fit(ifs_method="LR")
# Output incremental feature selection results
selection_result = classfier.ifs_results
# Plot incremental feature selection lines
classfier.plot_lines(selection_result, out=False)
# Extract the optimal feature set
X_train_best = classfier.transform(X_train)
X_test_best = classfier.transform(X_test)
# Build the model
model = classfier.train(X_train_best, y_train)
# Cross-validation
cv_result = classfier.cv_test(X_train_best, y_train, model)
# Plot cross-validation confusion matrix
classfier.plot_cm(cv_result['cm'], out=False)
# Plot cross-validation ROC curve
classfier.plot_roc(X_train_best, y_train, model, out=False)
# Plot cross-validation PRC curve
classfier.plot_prc(X_train_best, y_train, model, out=False)
# Independent test set validation
y_pred, y_pred_proba = classfier.predict(X_test_best, model)
# Calculate test results
it_result = classfier.calculate_metrics(y_test, y_pred)
# Plot independent test confusion matrix
classfier.plot_cm(it_result[0], out=False)
# Save incremental feature selection results
selection_result.to_csv('IFS_Calculation_Results.csv', index=None)
# Save independent test results
with open("Independent test.csv", "w") as file:
    file.write(f'ACC,SN,SP,MCC,F1\n{it_result[1]},{it_result[2]},{it_result[3]},{it_result[4]},{it_result[5]}')
# Save prediction results
predict_results = pd.DataFrame(y_pred_proba, columns=['Class 0 Proba', 'Class 1 Proba'])
predict_results['Pred Class'] = list(y_pred)
predict_results['True Class'] = list(y_test)
predict_results.to_csv('Prediction_Results.csv')
# Save the trained model
joblib.dump(model, 'Best_Model.mdl')
